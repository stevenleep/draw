# 浏览器绘画扩展架构图

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Chrome Extension                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐  │
│  │   Background    │    │   Content       │    │        Web Page             │  │
│  │     Script      │◄──►│     Script      │───►│      (Target Page)          │  │
│  │                 │    │                 │    │                             │  │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 详细架构层次

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              EXTENSION LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           BACKGROUND SCRIPT                                 │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │ Extension Icon  │  │ Message Handler │  │ Script Injection Manager   │ │ │
│  │  │   Click Event   │  │                 │  │                             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              CONTENT LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           CONTENT CONTROLLER                                │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │ DrawingManager  │  │ ToolbarManager  │  │ MessageHandler             │ │ │
│  │  │                 │  │                 │  │                             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              ENGINE LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           DRAWING ENGINE                                    │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │ DrawingState    │  │ ToolManager     │  │ DrawingRenderer            │ │ │
│  │  │                 │  │                 │  │                             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │TextEditingState │  │DrawingEventHandler│ │ Canvas Overlay            │ │ │
│  │  │                 │  │                 │  │                             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              PLUGIN LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           TOOL PLUGINS                                      │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │PenTool  │ │Rectangle│ │Circle   │ │TextTool │ │ArrowTool│ │LineTool │ │ │
│  │  │         │ │Tool     │ │Tool     │ │         │ │         │ │         │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │HandDrawn│ │Eraser   │ │Highlight│ │StarTool │ │Triangle │ │Select   │ │ │
│  │  │Tool     │ │Tool     │ │Tool     │ │         │ │Tool     │ │Tool     │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────────┤
│                              UI LAYER                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           TOOLBAR SYSTEM                                    │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │ ToolbarRenderer │  │ ToolbarEvents   │  │ SettingsManager            │ │ │
│  │  │                 │  │                 │  │                             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    PropertyPanel (Figma Style)                         │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 数据流向图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │───►│  Toolbar    │───►│ ToolManager │───►│ Drawing     │
│ Interaction │    │  Manager    │    │             │    │ Engine      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
                                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Canvas    │◄───│ Drawing     │◄───│ Drawing     │◄───│ Tool        │
│  Overlay    │    │ Renderer    │    │ State       │    │ Plugin      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 组件关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              COMPONENT RELATIONSHIPS                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ContentController                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                    │ │
│  │  │DrawingManager│◄──►│ToolbarManager│◄──►│MessageHandler│                    │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  DrawingEngine                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                    │ │
│  │  │DrawingState │◄──►│ToolManager  │◄──►│DrawingRenderer│                    │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                    │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                    │ │
│  │  │TextEditing  │    │DrawingEvent │    │Canvas       │                    │ │
│  │  │State        │    │Handler      │    │Overlay      │                    │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  Tool Plugins                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │PenTool  │ │Rectangle│ │Circle   │ │TextTool │ │ArrowTool│ │LineTool │ │ │
│  │  │         │ │Tool     │ │Tool     │ │         │ │         │ │         │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │HandDrawn│ │Eraser   │ │Highlight│ │StarTool │ │Triangle │ │Select   │ │ │
│  │  │Tool     │ │Tool     │ │Tool     │ │         │ │Tool     │ │Tool     │ │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 文件结构映射

```
src/
├── background.ts                    # 后台脚本入口
├── content/                         # 内容脚本层
│   ├── content.ts                   # 内容脚本入口
│   ├── ContentController.ts         # 主控制器
│   ├── core/                        # 核心功能
│   │   ├── DrawingManager.ts        # 绘画管理器
│   │   └── MessageHandler.ts        # 消息处理器
│   └── ui/                          # 用户界面
│       ├── ToolbarManager.ts        # 工具栏管理器
│       ├── ToolbarRenderer.ts       # 工具栏渲染器
│       ├── ToolbarEvents.ts         # 工具栏事件
│       └── SettingsManager.ts       # 设置管理器
└── lib/                             # 核心库
    ├── core/                        # 核心引擎
    │   ├── DrawingEngine.ts         # 绘画引擎
    │   └── types.ts                 # 类型定义
    ├── plugins/                     # 工具插件
    │   ├── ToolManager.ts           # 工具管理器
    │   ├── ToolPlugin.ts            # 工具插件基类
    │   ├── PenTool.ts               # 画笔工具
    │   ├── RectangleTool.ts         # 矩形工具
    │   └── ...                      # 其他工具
    ├── state/                       # 状态管理
    │   ├── DrawingState.ts          # 绘画状态
    │   └── TextEditingState.ts      # 文本编辑状态
    ├── events/                      # 事件处理
    │   └── DrawingEventHandler.ts   # 绘画事件处理器
    └── rendering/                   # 渲染系统
        └── DrawingRenderer.ts       # 绘画渲染器
```

## 技术栈架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              TECHNOLOGY STACK                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   TypeScript    │  │      Vite       │  │   Chrome API    │                │
│  │                 │  │                 │  │                 │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
│           │                     │                     │                        │
│           ▼                     ▼                     ▼                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Canvas API    │  │   DOM API       │  │   Manifest V3   │                │
│  │                 │  │                 │  │                 │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
│           │                     │                     │                        │
│           ▼                     ▼                     ▼                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           CORE FEATURES                                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │ │
│  │  │Plugin System│  │State Mgmt   │  │Event System │  │Rendering    │      │ │
│  │  │             │  │             │  │             │  │System       │      │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 工作流程时序图

```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│  User   │ │Background│ │Content  │ │Drawing  │ │Toolbar  │ │ Canvas  │
│         │ │ Script  │ │Script   │ │Manager  │ │Manager  │ │ Overlay │
└─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘
     │           │           │           │           │           │
     │ Click     │           │           │           │           │
     │ Extension │           │           │           │           │
     │ Icon      │           │           │           │           │
     │──────────►│           │           │           │           │
     │           │ Toggle    │           │           │           │
     │           │ Message   │           │           │           │
     │           │──────────►│           │           │           │
     │           │           │ Activate  │           │           │
     │           │           │ Drawing   │           │           │
     │           │           │──────────►│           │           │
     │           │           │           │ Create    │           │
     │           │           │           │ Canvas    │           │
     │           │           │           │──────────►│           │
     │           │           │           │           │ Create    │
     │           │           │           │           │ Toolbar   │
     │           │           │           │           │──────────►│
     │           │           │           │           │           │ Ready
     │           │           │           │           │           │◄─────────
     │           │           │           │           │ Ready     │
     │           │           │           │           │◄─────────│
     │           │           │           │ Ready     │           │
     │           │           │           │◄─────────│           │
     │           │           │ Ready     │           │           │
     │           │           │◄─────────│           │           │
     │           │ Success   │           │           │           │
     │           │◄─────────│           │           │           │
     │ Success   │           │           │           │           │
     │◄─────────│           │           │           │           │
```

## 关键设计模式

### 1. 插件模式 (Plugin Pattern)

- 所有工具都继承自 `ToolPlugin` 抽象类
- 通过 `ToolManager` 统一管理工具注册和切换
- 支持动态添加新工具

### 2. 观察者模式 (Observer Pattern)

- 事件处理器监听用户交互
- 状态变化时通知相关组件更新
- 工具切换时更新UI状态

### 3. 状态管理模式 (State Management Pattern)

- `DrawingState` 管理绘画对象状态
- `TextEditingState` 管理文本编辑状态
- 支持撤销/重做操作

### 4. 工厂模式 (Factory Pattern)

- `ToolManager` 作为工具工厂
- 统一创建和管理工具实例

### 5. 策略模式 (Strategy Pattern)

- 不同工具实现不同的绘制策略
- 运行时动态切换绘制策略

## 性能优化策略

1. **Canvas优化**
   - 使用离屏Canvas进行复杂渲染
   - 按需重绘，避免不必要的渲染

2. **事件优化**
   - 事件委托减少事件监听器数量
   - 防抖处理频繁事件

3. **内存管理**
   - 及时清理不需要的对象
   - 避免内存泄漏

4. **渲染优化**
   - 分层渲染减少重绘
   - 使用requestAnimationFrame优化动画

这个架构设计展现了现代Web扩展开发的最佳实践，具有高度的模块化、可扩展性和可维护性。
